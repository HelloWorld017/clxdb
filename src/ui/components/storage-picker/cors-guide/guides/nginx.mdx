import { LocationOrigin } from '../location-origin.tsx';
import { UntestedWarning } from '../warnings.tsx';

<UntestedWarning />

## Introduction

Use Nginx as a CORS layer when your backend cannot expose the required headers directly.
The method and header set below works for both WebDAV and S3-compatible requests.

## How-To

1. In the Nginx `http` block, define an origin allowlist:

```nginx
map $http_origin $extra_cors_origin {
  default "";
  "https://app.example.com" $http_origin;
}
```

2. In your `server` block, configure the proxy location:

```nginx
location /some-path-to-storage/ {
  set $extra_cors_preflight "";

  if ($request_method = OPTIONS) {
    set $extra_cors_preflight "OPTIONS";
  }

  if ($extra_cors_origin) {
    set $extra_cors_preflight "${extra_cors_preflight}_ALLOWED";
  }

  if ($extra_cors_preflight = "OPTIONS_ALLOWED") {
    add_header Access-Control-Allow-Origin $extra_cors_origin always;
    add_header Access-Control-Allow-Methods "GET, PUT, POST, DELETE, HEAD, OPTIONS, PROPFIND, MKCOL" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Depth, Destination, If, If-Match, If-None-Match, If-Unmodified-Since, Overwrite, Range, x-amz-content-sha256, x-amz-date, x-amz-security-token, x-amz-user-agent" always;
    add_header Access-Control-Expose-Headers "ETag, Content-Length, Last-Modified, DAV, x-amz-request-id, x-amz-id-2, x-amz-version-id" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age "86400" always;
    return 204;
  }

  if ($extra_cors_origin) {
    add_header Access-Control-Allow-Origin $extra_cors_origin always;
    add_header Access-Control-Expose-Headers "ETag, Content-Length, Last-Modified, DAV, x-amz-request-id, x-amz-id-2, x-amz-version-id" always;
    add_header Access-Control-Allow-Credentials "true" always;
  }

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_pass http://your-upstream;
}
```

3. Replace `https://app.example.com` with this app origin: <LocationOrigin />.
4. Reload Nginx and retry.
